var UTIL=function(f){var g={};f.BlobBuilder=f.BlobBuilder||f.MozBlobBuilder||f.WebKitBlobBuilder;f.requestFileSystem=f.requestFileSystem||f.webkitRequestFileSystem;f.storageInfo=f.storageInfo||f.webkitStorageInfo;f.URL=f.URL||f.webkitURL||f.mozURL;g.binStr2ArrBuf=function(d){for(var c=new ArrayBuffer(d.length),a=new Uint8Array(c),b=0;b<c.byteLength;b++)a[b]=d.charCodeAt(b);return c};g.arrBuf2Blob=function(d,c){var a=new BlobBuilder;a.append(d);return a.getBlob(c)};g.blob2BinStr=function(d,c){var a=
new FileReader;a.onload=function(a){c(a.target.result)};a.readAsBinaryString(d)};g.createUrl=function(d,c,a){f.URL?(c=f.URL.createObjectURL(c),a(c)):(d=new FileReader,d.onload=function(b){a(b.target.result)},d.readAsDataURL(c))};return g}(window);"use strict";var MENU=function(){return{getLoginInfo:function(f,g){$.get("/login?requestUri="+f,function(d){g(d)})}}}();"use strict";
var MENUVIEW=function(f,g){var d={init:function(c,a){g.getLoginInfo(c,function(b){d.updateLogin(b);a(b)})},updateLogin:function(c){var a="",a=c.loggedIn?'Logout <a href="'+c.logoutUrl+'">'+c.email+"</a>":'Try the alpha: Login with your <a href="'+c.loginUrl+'">Google Account</a>';f("#login").html(a)}};return d}($,MENU);"use strict";
var SERVER=function(f,g){var d={call:function(c,a,b){f.ajax({type:c,url:a,success:function(a){b(a)},error:function(e,b,k){alert("Error calling "+c+" on "+a+": "+k)}})},upload:function(c,a,b,e,h){f.ajax({type:c,url:a,contentType:b,data:e,success:function(a){h(a)},error:function(e,b,h){alert("Error calling "+c+" on "+a+": "+h)}})},uploadBlob:function(c,a,b){function e(e){var k=new FormData;k.append("file",c);k.append("md5",a);var n=new XMLHttpRequest;n.open("POST",e,!0);n.onload=function(){if(201==
this.status){var a=JSON.parse(this.response).blobKey;b(a)}else alert("Error uploading blob: "+this.status)};n.send(k)}d.call("GET","/app/uploadBlob?md5="+a,function(a){a.blobKey?b(a.blobKey):e(a.uploadUrl)})},downloadBlob:function(c,a){var b=new XMLHttpRequest;b.open("GET","/app/blobs?blob-key="+c,!0);b.responseType="arraybuffer";b.onload=function(){if(200==this.status){var e=g.arrBuf2Blob(this.response,"application/octet-stream");a(e)}else alert("Error downloading blob: "+this.status)};b.send()},
deleteBlob:function(c,a){d.call("DELETE","/app/blobs?blob-key="+c,function(b){a(b)})}};return d}($,UTIL);"use strict";
var CRYPTO=function(f,g,d,c){var a={},b,e,h;g.init();a.initKeyPair=function(e,b,c,h){e.publicKeyId?(c=f.atob(e.publicKeyId),b(c)):c(function(){a.createAndPersistKeys(e.email,function(a){b(a);h()})})};a.createAndPersistKeys=function(e,b){var h=a.generateKeys(2048,e),d=h.privateKey.getKeyId(),g=f.btoa(d),i={keyId:g,ownerEmail:e,asciiArmored:h.privateKeyArmored},h=JSON.stringify({keyId:g,ownerEmail:e,asciiArmored:h.publicKeyArmored}),o=JSON.stringify(i);c.upload("POST","/app/publicKeys","application/json",
h,function(){c.upload("POST","/app/privateKeys","application/json",o,function(){b(d)})})};a.generateKeys=function(e,b){if(!h&&""!==h)throw"No passphrase set!";var c=g.generate_key_pair(1,e,"SafeWith.me User <"+b+">",h);a.importKeys(c.publicKeyArmored,c.privateKeyArmored,b);return c};a.importKeys=function(a,e,b){if(!h&&""!==h)throw"No passphrase set!";g.keyring.importPrivateKey(e,h);g.keyring.importPublicKey(a);g.keyring.store();f.localStorage.setItem(b+"Passphrase",h)};a.exportKeys=function(a){var c=
d.binStr2ArrBuf(e.armored+b.armored),c=d.arrBuf2Blob(c,"text/plain");d.createUrl("safewithme.keys.txt",c,a)};a.readKeys=function(a,c,d,l){var j=g.keyring.getPrivateKeyForAddress(a),i=g.keyring.getPublicKeyForAddress(a);if(c){for(var o=0;o<j.length;o++)if(j[o].keyId===c){b=j[o];break}for(j=0;j<i.length;j++)if(i[j].keyId===c){e=i[j];break}}else b=j[0],e=i[0];if(!e||!b||e.keyId!==b.keyId)l();else{h=f.localStorage.getItem(a+"Passphrase");if(!h&&""!==h)throw"No passphrase for that user in localstorage!";
d&&d()}};a.fetchKeys=function(e,b,h){var b=f.btoa(b),d=encodeURIComponent(b);c.call("GET","/app/publicKeys?keyId="+d,function(b){c.call("GET","/app/privateKeys?keyId="+d,function(c){a.importKeys(b.asciiArmored,c.asciiArmored,e);h({privateKey:c,publicKey:b})})})};a.getPrivateKey=function(){return!b?void 0:b.armored};a.getPublicKey=function(){return!e?void 0:e.armored};a.getPublicKeyIdBase64=function(){return f.btoa(e.keyId)};a.setPassphrase=function(a){h=a};a.asymmetricEncrypt=function(a,b){var c=
null,c=b?g.read_publicKey(b):g.read_publicKey(e.armored);return g.write_encrypted_message(c,a)};a.asymmetricDecrypt=function(a){for(var e=g.read_privateKey(b.armored),a=g.read_message(a),c=null,d=null,f=0;f<a[0].sessionKeys.length;f++){if(e[0].privateKeyPacket.publicKey.getKeyId()==a[0].sessionKeys[f].keyId.bytes){c={key:e[0],keymaterial:e[0].privateKeyPacket};d=a[0].sessionKeys[f];break}for(var i=0;i<e[0].subKeys.length;i++)if(e[0].subKeys[i].publicKey.getKeyId()==a[0].sessionKeys[f].keyId.bytes){c=
{key:e[0],keymaterial:e[0].subKeys[i]};d=a[0].sessionKeys[f];break}}if(null!=c){if(!c.keymaterial.decryptSecretMPIs(h))throw"Passphrase for secrect key was incorrect!";return a[0].decrypt(c,d)}throw"No private key found!";};a.symmetricEncrypt=function(a){var e=str_sha1(a),b=str_sha256(e),e=str_sha1(e).substr(0,16),a=openpgp_crypto_symmetricEncrypt(e,9,b,a,0);return{key:f.btoa(b),ct:a}};a.symmetricDecrypt=function(a,e){return openpgp_crypto_symmetricDecrypt(9,f.atob(a),e,0)};return a}(window,openpgp,
UTIL,SERVER);function showMessages(){}"use strict";
var CRYPTOVIEW=function(f,g,d){var c={init:function(a,b){d.initKeyPair(a,function(e){d.readKeys(a.email,e,b,function(){c.showImportKeys(a,e,b)})},function(a){g("#genKeysForm").submit(function(b){b.preventDefault();b=g("#passphrase").val();d.setPassphrase(b);g("#keygenStatus").html('<div class="progress progress-danger progress-striped active"><div class="bar" style="width: 100%;"></div></div>');a()});g("#disclaimerModal").modal("show")},function(){d.exportKeys(function(a){g("#keygenStatus").html('<h2 class="alert alert-success">Completed! '+('<a style="float:right" class="btn btn-large btn-danger" download="safewithme.keys.txt" href="'+
a+'">Export Keys</a>')+"</h2>")})})},showImportKeys:function(a,b,e){g("#importKeysModal").modal("show");g("#importBtn").click(function(){var c=g("#passphraseImport").val();d.setPassphrase(c);d.fetchKeys(a.email,b,function(){d.readKeys(a.email,b,function(){f.alert("Key import from server successful!");g("#importKeysModal").modal("hide");e()},function(){f.alert("Key import failed... please check your passphrase!")})})})}};return c}(window,$,CRYPTO);"use strict";
var CACHE=function(f){function g(c,a,b,e){function h(d){d.root.getFile(c,a,function(a){b(a)},e)}f.storageInfo.requestQuota(f.PERSISTENT,104857600,function(a){f.requestFileSystem(f.PERSISTENT,a,h,d)},d)}function d(c){console.log("Error",c)}return{storeObject:function(c,a){var b=JSON.stringify(a);f.localStorage.setItem(c,b)},readObject:function(c){c=f.localStorage.getItem(c);return JSON.parse(c)},removeObject:function(c){f.localStorage.removeItem(c)},storeBlob:function(c,a,b){g(c,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=
function(){b(!0)};e.onerror=function(a){d(a)};e.write(a)})},d)},readBlob:function(c,a){g(c,{},function(b){b.file(function(e){a(e)})},function(){a(null)})},removeBlob:function(c,a){g(c,{create:!1},function(b){b.remove(function(){a(!0)},d)},function(){a(!1)})}}}(window);"use strict";
var FS=function(f,g,d,c){var a={BucketFS:function(a,b,c){this.version="1.0";this.id=a;this.name=b;this.ownerEmail=c;this.created=(new Date).toISOString();this.root=[]},Directory:function(a){this.type="dir";this.name=a;this.created=(new Date).toISOString();this.children=[]},File:function(a,b,c,d,f,g){this.type="file";this.name=a;this.size=b;this.uploaded=(new Date).toISOString();this.mimeType=c;this.blobKey=d;this.cryptoKey=f;this.md5=g}},b=[];a.cacheBucket=function(a,c){b.push({bucket:a,bucketFS:c})};
a.currentBucket=function(){return b[0].bucket};a.currentBucketFS=function(){return b[0].bucketFS};a.storeFile=function(e,b,k){d.blob2BinStr(e,function(n){var m=f.symmetricEncrypt(n),n=d.binStr2ArrBuf(m.ct),l=d.arrBuf2Blob(n,"application/octet-stream"),j=md5(m.ct);c.storeBlob(j,l,function(){b();g.uploadBlob(l,j,function(b){var c=new a.File(e.name,e.size,e.type,b,m.key,j),b=a.currentBucket(),d=a.currentBucketFS();a.addFileToBucketFS(c,d,b,function(a){k(c,a)})})})})};a.getFile=function(a,b){function k(c){d.blob2BinStr(c,
function(c){c=f.symmetricDecrypt(a.cryptoKey,c);c=d.binStr2ArrBuf(c);c=d.arrBuf2Blob(c,a.mimeType);d.createUrl(a.name,c,function(a){b(a)})})}c.readBlob(a.md5,function(b){b?k(b):g.downloadBlob(a.blobKey,function(b){c.storeBlob(a.md5,b,function(){k(b)})})})};a.deleteFile=function(b,d){c.removeBlob(b.md5,function(){g.deleteBlob(b.blobKey,function(){var c=a.currentBucket(),f=a.currentBucketFS();a.deleteFileFromBucketFS(b.blobKey,f,c,function(){d()})})})};a.getBuckets=function(a){g.call("GET","/app/buckets",
function(b){a(b)})};a.getBucketFS=function(a){a=f.asymmetricDecrypt(a);return JSON.parse(a)};a.addFileToBucketFS=function(b,c,d,f){c.root.push(b);a.persistBucketFS(c,d,function(a){f(a)})};a.deleteFileFromBucketFS=function(b,c,d,f){for(var g=0;g<c.root.length;g++){var l=c.root[g];if("file"===l.type&&l.blobKey===b){c.root.splice(g,1);break}}a.persistBucketFS(c,d,function(a){f(a)})};a.persistBucketFS=function(a,b,c,d){var a=JSON.stringify(a),m=null,m=d?f.asymmetricEncrypt(a,d):f.asymmetricEncrypt(a);
b.encryptedFS=m;b.publicKeyId=f.getPublicKeyIdBase64();b=JSON.stringify(b);g.upload("PUT","/app/buckets","application/json",b,function(a){c(a)})};a.createBucket=function(b,c){g.call("POST","/app/buckets",function(d){var f=new a.BucketFS(d.id,b,d.ownerEmail);a.persistBucketFS(f,d,function(a){c(a)})})};a.removeBucket=function(a,b){g.call("DELETE","/app/buckets?bucketId="+a.id,function(a){b(a)})};a.shareFile=function(b,c,d,f,m){g.call("GET","/app/publicKeys?email="+d,function(l){l&&m&&m();g.call("POST",
"/app/buckets",function(g){var i=new a.BucketFS(g.id,c,d);i.root.push(b);g.ownerEmail=d;a.persistBucketFS(i,g,function(a){f(a)},l.asciiArmored)})})};return a}(CRYPTO,SERVER,UTIL,CACHE);"use strict";
var FSVIEW=function(f,g,d,c){var a={init:function(){var b=g.getElementById("holder");b.ondragover=function(){return!1};b.ondragend=function(){return!1};b.ondrop=function(b){b.preventDefault();a.handleFileDrop(b.dataTransfer.files[0])};g.getElementById("files").addEventListener("change",function(b){a.handleFileDrop(b.target.files[0])},!1);c.getBuckets(function(b){if(0===b.length)c.createBucket("Personal Documents",function(b){a.displayBucket(b,0,1)});else for(var d=0;d<b.length;d++)a.displayBucket(b[d],
d,b.length)})},handleFileDrop:function(b){d("#encryptModal").on("shown",function(){c.storeFile(b,function(){d("#encryptModal").modal("hide")},function(b){a.addLinkToList(b)})});d("#encryptModal").modal("show")},displayBucket:function(b){var e=c.getBucketFS(b.encryptedFS);c.cacheBucket(b,e);b='<li class="nav-header">'+e.name+"</li>";d("#buckets").append(b);for(b=0;b<e.root.length;b++)a.addLinkToList(e.root[b])},addLinkToList:function(b){var e=b.blobKey,f='<li><div><a id="deleteItem" href="'+e+'"><i class="icon-remove icon-black"></i></a><a id="showItem" href="'+
e+'">'+b.name+'</a><a id="shareItem" href="'+e+'"><i class="icon-share-alt icon-black"></i></a></div></li>';d("#buckets").append(f);d('#showItem[href="'+e+'"]').click(function(c){c.preventDefault();a.showDocItem(b)});d('#deleteItem[href="'+e+'"]').click(function(c){c.preventDefault();a.deleteDocItem(b)});d('#shareItem[href="'+e+'"]').click(function(a){a.preventDefault();d("#shareModal").modal("show")});d("#shareForm").submit(function(a){a.preventDefault();var a=d("#login a").html(),e=d("#shareEmail").val();
if(!e||""===e)return alert("You must specify the recipient's email!"),!1;c.shareFile(b,"shared by "+a,e,function(){d("#encryptModal").modal("hide")},function(){d("#shareModal").modal("hide");d("#encryptModal").modal("show")});return!1})},showDocItem:function(b){d("#decryptModal").on("shown",function(){c.getFile(b,function(b){d("#decryptModal").modal("hide");a.displayDoc(b)})});d("#decryptModal").modal("show");return!1},deleteDocItem:function(a){c.deleteFile(a,function(){d('[href="'+a.blobKey+'"]').remove()})},
displayDoc:function(a){f.location.href=a}};return a}(window,document,$,FS);"use strict";var SAFEWITHME=function(f,g,d,c,a){return{init:function(){var b;!f.BlobBuilder||!f.requestFileSystem||!f.storageInfo?(f.alert("Sorry, your browser does not yet support all the necessary HTML5 Apis. Try using Chrome."),b=!1):b=!0;b&&d.init("http://safewith.me",function(b){b.loggedIn&&b.email&&c.init(b,function(){a.init()})})}}}(window,navigator,MENUVIEW,CRYPTOVIEW,FSVIEW);$(function(){SAFEWITHME.init()});
