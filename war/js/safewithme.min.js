var UTIL=function(f){var g={};f.BlobBuilder=f.BlobBuilder||f.MozBlobBuilder||f.WebKitBlobBuilder;f.requestFileSystem=f.requestFileSystem||f.webkitRequestFileSystem;f.storageInfo=f.storageInfo||f.webkitStorageInfo;f.URL=f.URL||f.webkitURL||f.mozURL;g.binStr2ArrBuf=function(e){for(var b=new ArrayBuffer(e.length),d=new Uint8Array(b),a=0;a<b.byteLength;a++)d[a]=e.charCodeAt(a);return b};g.arrBuf2Blob=function(e,b){var d=new BlobBuilder;d.append(e);return d.getBlob(b)};g.blob2BinStr=function(e,b){var d=
new FileReader;d.onload=function(a){b(a.target.result)};d.readAsBinaryString(e)};g.createUrl=function(e,b,d){function a(a){a.root.getFile(e,{create:!0},function(a){a.createWriter(function(c){c.onwriteend=function(){var c=a.toURL();d(c)};c.onerror=function(a){console.log("Write failed: "+a.toString())};c.write(b)})})}if(f.requestFileSystem)f.requestFileSystem(f.TEMPORARY,b.size,a);else if(f.URL){var c=f.URL.createObjectURL(b);d(c)}else c=new FileReader,c.onload=function(a){d(a.target.result)},c.readAsDataURL(b)};
return g}(window);"use strict";var MENU=function(){return{getLoginInfo:function(f,g){$.get("/login?requestUri="+f,function(e){g(e)})}}}();"use strict";var MENUVIEW=function(f,g){var e={init:function(b,d){g.getLoginInfo(b,function(a){e.updateLogin(a);d(a)})},updateLogin:function(b){var d="",d=b.loggedIn?'Logout <a href="'+b.logoutUrl+'">'+b.email+"</a>":'Try the alpha: Login with your <a href="'+b.loginUrl+'">Google Account</a>';f("#login").html(d)}};return e}($,MENU);"use strict";
var SERVER=function(f,g){var e={call:function(b,d,a){f.ajax({type:b,url:d,success:function(c){a(c)},error:function(a,h,m){alert("Error calling "+b+" on "+d+": "+m)}})},upload:function(b,d,a,c,h){f.ajax({type:b,url:d,contentType:a,data:c,success:function(a){h(a)},error:function(a,c,h){alert("Error calling "+b+" on "+d+": "+h)}})},uploadBlob:function(b,d,a){function c(c){var m=new FormData;m.append("file",b);m.append("md5",d);var k=new XMLHttpRequest;k.open("POST",c,!0);k.onload=function(){if(201==
this.status){var c=JSON.parse(this.response).blobKey;a(c)}else alert("Error uploading blob: "+this.status)};k.send(m)}e.call("GET","/app/uploadBlob?md5="+d,function(b){b.blobKey?a(b.blobKey):c(b.uploadUrl)})},downloadBlob:function(b,d){var a=new XMLHttpRequest;a.open("GET","/app/blobs?blob-key="+b,!0);a.responseType="arraybuffer";a.onload=function(){if(200==this.status){var a=g.arrBuf2Blob(this.response,"application/octet-stream");d(a)}else alert("Error downloading blob: "+this.status)};a.send()},
deleteBlob:function(b,d){e.call("DELETE","/app/blobs?blob-key="+b,function(a){d(a)})}};return e}($,UTIL);"use strict";
var CRYPTO=function(f,g,e,b){var d={},a,c,h;g.init();d.initKeyPair=function(a,c,b,h){a.publicKeyId?(b=f.atob(a.publicKeyId),c(b)):b(function(){d.createAndPersistKeys(a.email,function(a){c(a);h()})})};d.createAndPersistKeys=function(a,c){var h=d.generateKeys(2048,a),e=h.privateKey.getKeyId(),g=f.btoa(e),i={keyId:g,ownerEmail:a,asciiArmored:h.privateKeyArmored},h=JSON.stringify({keyId:g,ownerEmail:a,asciiArmored:h.publicKeyArmored}),l=JSON.stringify(i);b.upload("POST","/app/publicKeys","application/json",
h,function(){b.upload("POST","/app/privateKeys","application/json",l,function(){c(e)})})};d.generateKeys=function(a,c){if(!h)throw"No passphrase set!";var b=g.generate_key_pair(1,a,"SafeWith.me User <"+c+">",h);d.importKeys(b.publicKeyArmored,b.privateKeyArmored,c);return b};d.importKeys=function(a,c,b){if(!h)throw"No passphrase set!";g.keyring.importPrivateKey(c,h);g.keyring.importPublicKey(a);g.keyring.store();f.localStorage.setItem(b+"Passphrase",h)};d.exportKeys=function(b){var d=e.arrBuf2Blob(c.armored+
a.armored,"text/plain");e.createUrl("safewithme.keys.txt",d,b)};d.readKeys=function(b,d,e,o){var j=g.keyring.getPrivateKeyForAddress(b),i=g.keyring.getPublicKeyForAddress(b);if(d){for(var l=0;l<j.length;l++)if(j[l].keyId===d){a=j[l];break}for(j=0;j<i.length;j++)if(i[j].keyId===d){c=i[j];break}}else a=j[0],c=i[0];if(!c||!a||c.keyId!==a.keyId)o();else{h=f.localStorage.getItem(b+"Passphrase");if(!h)throw"No passphrase for that user in localstorage!";e&&e()}};d.fetchKeys=function(a,c,h){var c=f.btoa(c),
e=encodeURIComponent(c);b.call("GET","/app/publicKeys?keyId="+e,function(c){b.call("GET","/app/privateKeys?keyId="+e,function(b){d.importKeys(c.asciiArmored,b.asciiArmored,a);h({privateKey:b,publicKey:c})})})};d.getPrivateKey=function(){return!a?void 0:a.armored};d.getPublicKey=function(){return!c?void 0:c.armored};d.getPublicKeyIdBase64=function(){return f.btoa(c.keyId)};d.setPassphrase=function(a){h=a};d.asymmetricEncrypt=function(a,b){var d=null,d=b?g.read_publicKey(b):g.read_publicKey(c.armored);
return g.write_encrypted_message(d,a)};d.asymmetricDecrypt=function(c){for(var b=g.read_privateKey(a.armored),c=g.read_message(c),d=null,e=null,f=0;f<c[0].sessionKeys.length;f++){if(b[0].privateKeyPacket.publicKey.getKeyId()==c[0].sessionKeys[f].keyId.bytes){d={key:b[0],keymaterial:b[0].privateKeyPacket};e=c[0].sessionKeys[f];break}for(var i=0;i<b[0].subKeys.length;i++)if(b[0].subKeys[i].publicKey.getKeyId()==c[0].sessionKeys[f].keyId.bytes){d={key:b[0],keymaterial:b[0].subKeys[i]};e=c[0].sessionKeys[f];
break}}if(null!=d){if(!d.keymaterial.decryptSecretMPIs(h))throw"Passphrase for secrect key was incorrect!";return c[0].decrypt(d,e)}throw"No private key found!";};d.symmetricEncrypt=function(a){var c=str_sha1(a),b=str_sha256(c),c=str_sha1(c).substr(0,16),a=openpgp_crypto_symmetricEncrypt(c,9,b,a,0);return{key:f.btoa(b),ct:a}};d.symmetricDecrypt=function(a,c){return openpgp_crypto_symmetricDecrypt(9,f.atob(a),c,0)};return d}(window,openpgp,UTIL,SERVER);function showMessages(){}"use strict";
var CRYPTOVIEW=function(f,g,e){var b={init:function(d,a){e.initKeyPair(d,function(c){e.readKeys(d.email,c,a,function(){b.showImportKeys(d,c,a)})},function(a){g("#genKeysForm").submit(function(b){b.preventDefault();b=g("#passphrase").val();e.setPassphrase(b);g("#keygenStatus").html('<div class="progress progress-danger progress-striped active"><div class="bar" style="width: 100%;"></div></div>');a()});g("#disclaimerModal").modal("show")},function(){e.exportKeys(function(a){g("#keygenStatus").html('<h2 class="alert alert-success">Completed! '+
('<a style="float:right" class="btn btn-large btn-danger" download="safewithme.keys.txt" href="'+a+'">Export Keys</a>')+"</h2>")})})},showImportKeys:function(b,a,c){g("#importKeysModal").modal("show");g("#importBtn").click(function(){var h=g("#passphraseImport").val();e.setPassphrase(h);e.fetchKeys(b.email,a,function(){e.readKeys(b.email,a,function(){f.alert("Key import from server successful!");g("#importKeysModal").modal("hide");c()},function(){f.alert("Key import failed... please check your passphrase!")})})})}};
return b}(window,$,CRYPTO);"use strict";
var FS=function(f,g,e){var b={},d=[];b.BucketFS=function(a,c,b){this.version="1.0";this.id=a;this.name=c;this.ownerEmail=b;this.created=(new Date).toISOString();this.root=[]};b.Directory=function(a){this.type="dir";this.name=a;this.created=(new Date).toISOString();this.children=[]};b.File=function(a,c,b,d,e){this.type="file";this.name=a;this.size=c;this.uploaded=(new Date).toISOString();this.mimeType=b;this.blobKey=d;this.cryptoKey=e};b.cacheBucket=function(a,c){d.push({bucket:a,bucketFS:c})};b.currentBucket=
function(){return d[0].bucket};b.currentBucketFS=function(){return d[0].bucketFS};b.readFile=function(a,c){e.blob2BinStr(a,function(a){var b=f.symmetricEncrypt(a),a=e.binStr2ArrBuf(b.ct),a=e.arrBuf2Blob(a,"application/octet-stream"),d=md5(b.ct);g.uploadBlob(a,d,function(a){c(a,b.key)})})};b.getFile=function(a,c){g.downloadBlob(a.blobKey,function(b){e.blob2BinStr(b,function(b){b=f.symmetricDecrypt(a.cryptoKey,b);b=e.binStr2ArrBuf(b);b=e.arrBuf2Blob(b,a.mimeType);e.createUrl(a.name,b,function(a){c(a)})})})};
b.deleteFile=function(a,b){g.deleteBlob(a,function(){b()})};b.getBuckets=function(a){g.call("GET","/app/buckets",function(b){a(b)})};b.getBucketFS=function(a){a=f.asymmetricDecrypt(a);return JSON.parse(a)};b.addFileToBucketFS=function(a,c,d,e){c.root.push(a);b.persistBucketFS(c,d,function(a){e(a)})};b.deleteFileFromBucketFS=function(a,c,d,e){for(var f=0;f<c.root.length;f++){var g=c.root[f];if("file"===g.type&&g.blobKey===a){c.root.splice(f,1);break}}b.persistBucketFS(c,d,function(a){e(a)})};b.persistBucketFS=
function(a,b,d,e){var a=JSON.stringify(a),k=null,k=e?f.asymmetricEncrypt(a,e):f.asymmetricEncrypt(a);b.encryptedFS=k;b.publicKeyId=f.getPublicKeyIdBase64();b=JSON.stringify(b);g.upload("PUT","/app/buckets","application/json",b,function(a){d(a)})};b.createBucket=function(a,c){g.call("POST","/app/buckets",function(d){var e=new b.BucketFS(d.id,a,d.ownerEmail);b.persistBucketFS(e,d,function(a){c(a)})})};b.removeBucket=function(a,b){g.call("DELETE","/app/buckets?bucketId="+a.id,function(a){b(a)})};b.shareFile=
function(a,c,d,e,f){g.call("GET","/app/publicKeys?email="+d,function(n){n&&f&&f();g.call("POST","/app/buckets",function(f){var g=new b.BucketFS(f.id,c,d);g.root.push(a);f.ownerEmail=d;b.persistBucketFS(g,f,function(a){e(a)},n.asciiArmored)})})};return b}(CRYPTO,SERVER,UTIL);"use strict";
var FSVIEW=function(f,g,e,b){var d={init:function(){var a=g.getElementById("holder");a.ondragover=function(){return!1};a.ondragend=function(){return!1};a.ondrop=function(a){a.preventDefault();d.handleFileDrop(a.dataTransfer.files[0])};g.getElementById("files").addEventListener("change",function(a){d.handleFileDrop(a.target.files[0])},!1);b.getBuckets(function(a){if(0===a.length)b.createBucket("Personal Documents",function(a){d.displayBucket(a,0,1)});else for(var e=0;e<a.length;e++)d.displayBucket(a[e],
e,a.length)})},handleFileDrop:function(a){e("#encryptModal").on("shown",function(){b.readFile(a,function(c,f){var g=new b.File(a.name,a.size,a.type,c,f),k=b.currentBucket(),n=b.currentBucketFS();b.addFileToBucketFS(g,n,k,function(){e("#encryptModal").modal("hide");d.addLinkToList(g)})})});e("#encryptModal").modal("show")},displayBucket:function(a){var c=b.getBucketFS(a.encryptedFS);b.cacheBucket(a,c);a='<li class="nav-header">'+c.name+"</li>";e("#buckets").append(a);for(a=0;a<c.root.length;a++)d.addLinkToList(c.root[a])},
addLinkToList:function(a){var c=a.blobKey,f='<li><div><a id="deleteItem" href="'+c+'"><i class="icon-remove icon-black"></i></a><a id="showItem" href="'+c+'">'+a.name+'</a><a id="shareItem" href="'+c+'"><i class="icon-share-alt icon-black"></i></a></div></li>';e("#buckets").append(f);e('#showItem[href="'+c+'"]').click(function(b){b.preventDefault();d.showDocItem(a)});e('#deleteItem[href="'+c+'"]').click(function(a){a.preventDefault();d.deleteDocItem(c)});e('#shareItem[href="'+c+'"]').click(function(a){a.preventDefault();
e("#shareModal").modal("show")});e("#shareForm").submit(function(c){c.preventDefault();var c=e("#login a").html(),d=e("#shareEmail").val();if(!d||""===d)return alert("You must specify the recipient's email!"),!1;b.shareFile(a,"shared by "+c,d,function(){e("#encryptModal").modal("hide")},function(){e("#shareModal").modal("hide");e("#encryptModal").modal("show")});return!1})},showDocItem:function(a){e("#decryptModal").on("shown",function(){b.getFile(a,function(a){e("#decryptModal").modal("hide");d.displayDoc(a)})});
e("#decryptModal").modal("show");return!1},deleteDocItem:function(a){b.deleteFile(a,function(){var c=b.currentBucket(),d=b.currentBucketFS();b.deleteFileFromBucketFS(a,d,c,function(){e('[href="'+a+'"]').remove()})})},displayDoc:function(a){f.location.href=a}};return d}(window,document,$,FS);"use strict";
var SAFEWITHME=function(f,g,e,b,d){return{init:function(){var a;!f.BlobBuilder||!f.requestFileSystem||!f.storageInfo?(f.alert("Your browser does not yet support all necessary HTML5 Apis!"),a=!1):a=!0;a&&e.init("http://safewith.me",function(a){a.loggedIn&&a.email&&b.init(a,function(){d.init()})})}}}(window,navigator,MENUVIEW,CRYPTOVIEW,FSVIEW);$(function(){SAFEWITHME.init()});
