var UTIL=function(f){var g={};f.BlobBuilder=f.BlobBuilder||f.MozBlobBuilder||f.WebKitBlobBuilder;if(!f.BlobBuilder)return f.alert("Your browser does not support the BlobBuilder Api!"),null;g.binStr2ArrBuf=function(e){for(var b=new ArrayBuffer(e.length),c=new Uint8Array(b),a=0;a<b.byteLength;a++)c[a]=e.charCodeAt(a);return b};g.arrBuf2Blob=function(e,b){var c=new BlobBuilder;c.append(e);return c.getBlob(b)};g.blob2BinStr=function(e,b){var c=new FileReader;c.onload=function(a){b(a.target.result)};c.readAsBinaryString(e)};
g.createUrl=function(e,b,c){function a(a){a.root.getFile(e,{create:!0},function(a){a.createWriter(function(d){d.onwriteend=function(){var d=a.toURL();c(d)};d.onerror=function(a){console.log("Write failed: "+a.toString())};d.write(b)})})}f.requestFileSystem=f.requestFileSystem||f.webkitRequestFileSystem;f.URL=f.URL||f.webkitURL||f.mozURL;if(f.requestFileSystem)f.requestFileSystem(f.TEMPORARY,b.size,a);else if(f.URL){var d=f.URL.createObjectURL(b);c(d)}else d=new FileReader,d.onload=function(a){c(a.target.result)},
d.readAsDataURL(b)};return g}(window);"use strict";var MENU=function(){return{getLoginInfo:function(f,g){$.get("/login?requestUri="+f,function(e){g(e)})}}}();"use strict";var MENUVIEW=function(f,g){var e={init:function(b,c){g.getLoginInfo(b,function(a){e.updateLogin(a);c(a)})},updateLogin:function(b){var c="",c=b.loggedIn?'Logout <a href="'+b.logoutUrl+'">'+b.email+"</a>":'Try the alpha: Login with your <a href="'+b.loginUrl+'">Google Account</a>';f("#login").html(c)}};return e}($,MENU);"use strict";
var SERVER=function(f,g){var e={call:function(b,c,a){f.ajax({type:b,url:c,success:function(d){a(d)},error:function(a,h,m){alert("Error calling "+b+" on "+c+": "+m)}})},upload:function(b,c,a,d,h){f.ajax({type:b,url:c,contentType:a,data:d,success:function(a){h(a)},error:function(a,d,h){alert("Error calling "+b+" on "+c+": "+h)}})},uploadBlob:function(b,c,a){function d(d){var m=new FormData;m.append("file",b);m.append("md5",c);var k=new XMLHttpRequest;k.open("POST",d,!0);k.onload=function(){if(201==
this.status){var d=JSON.parse(this.response).blobKey;a(d)}else alert("Error uploading blob: "+this.status)};k.send(m)}e.call("GET","/app/uploadBlob?md5="+c,function(b){b.blobKey?a(b.blobKey):d(b.uploadUrl)})},downloadBlob:function(b,c){var a=new XMLHttpRequest;a.open("GET","/app/blobs?blob-key="+b,!0);a.responseType="arraybuffer";a.onload=function(){if(200==this.status){var a=g.arrBuf2Blob(this.response,"application/octet-stream");c(a)}else alert("Error downloading blob: "+this.status)};a.send()},
deleteBlob:function(b,c){e.call("DELETE","/app/blobs?blob-key="+b,function(a){c(a)})}};return e}($,UTIL);"use strict";
var CRYPTO=function(f,g,e,b){var c={},a,d,h;g.init();c.initKeyPair=function(a,d,b,h){a.publicKeyId?(b=f.atob(a.publicKeyId),d(b)):b(function(){c.createAndPersistKeys(a.email,function(a){d(a);h()})})};c.createAndPersistKeys=function(a,d){var h=c.generateKeys(2048,a),e=h.privateKey.getKeyId(),g=f.btoa(e),i={keyId:g,ownerEmail:a,asciiArmored:h.privateKeyArmored},h=JSON.stringify({keyId:g,ownerEmail:a,asciiArmored:h.publicKeyArmored}),l=JSON.stringify(i);b.upload("POST","/app/publicKeys","application/json",
h,function(){b.upload("POST","/app/privateKeys","application/json",l,function(){d(e)})})};c.generateKeys=function(a,d){if(!h)throw"No passphrase set!";var b=g.generate_key_pair(1,a,"SafeWith.me User <"+d+">",h);c.importKeys(b.publicKeyArmored,b.privateKeyArmored,d);return b};c.importKeys=function(a,d,b){if(!h)throw"No passphrase set!";g.keyring.importPrivateKey(d,h);g.keyring.importPublicKey(a);g.keyring.store();f.localStorage.setItem(b+"Passphrase",h)};c.exportKeys=function(b){var c=e.arrBuf2Blob(d.armored+
a.armored,"text/plain");e.createUrl("safewithme.keys.txt",c,b)};c.readKeys=function(b,c,e,o){var j=g.keyring.getPrivateKeyForAddress(b),i=g.keyring.getPublicKeyForAddress(b);if(c){for(var l=0;l<j.length;l++)if(j[l].keyId===c){a=j[l];break}for(j=0;j<i.length;j++)if(i[j].keyId===c){d=i[j];break}}else a=j[0],d=i[0];if(!d||!a||d.keyId!==a.keyId)o();else{h=f.localStorage.getItem(b+"Passphrase");if(!h)throw"No passphrase for that user in localstorage!";e&&e()}};c.fetchKeys=function(a,d,h){var d=f.btoa(d),
e=encodeURIComponent(d);b.call("GET","/app/publicKeys?keyId="+e,function(d){b.call("GET","/app/privateKeys?keyId="+e,function(b){c.importKeys(d.asciiArmored,b.asciiArmored,a);h({privateKey:b,publicKey:d})})})};c.getPrivateKey=function(){return!a?void 0:a.armored};c.getPublicKey=function(){return!d?void 0:d.armored};c.getPublicKeyIdBase64=function(){return f.btoa(d.keyId)};c.setPassphrase=function(a){h=a};c.asymmetricEncrypt=function(a,b){var c=null,c=b?g.read_publicKey(b):g.read_publicKey(d.armored);
return g.write_encrypted_message(c,a)};c.asymmetricDecrypt=function(d){for(var b=g.read_privateKey(a.armored),d=g.read_message(d),c=null,e=null,f=0;f<d[0].sessionKeys.length;f++){if(b[0].privateKeyPacket.publicKey.getKeyId()==d[0].sessionKeys[f].keyId.bytes){c={key:b[0],keymaterial:b[0].privateKeyPacket};e=d[0].sessionKeys[f];break}for(var i=0;i<b[0].subKeys.length;i++)if(b[0].subKeys[i].publicKey.getKeyId()==d[0].sessionKeys[f].keyId.bytes){c={key:b[0],keymaterial:b[0].subKeys[i]};e=d[0].sessionKeys[f];
break}}if(null!=c){if(!c.keymaterial.decryptSecretMPIs(h))throw"Passphrase for secrect key was incorrect!";return d[0].decrypt(c,e)}throw"No private key found!";};c.symmetricEncrypt=function(a){var d=str_sha1(a),b=str_sha256(d),d=str_sha1(d).substr(0,16),a=openpgp_crypto_symmetricEncrypt(d,9,b,a,0);return{key:f.btoa(b),ct:a}};c.symmetricDecrypt=function(a,d){return openpgp_crypto_symmetricDecrypt(9,f.atob(a),d,0)};return c}(window,openpgp,UTIL,SERVER);function showMessages(){}"use strict";
var CRYPTOVIEW=function(f,g,e){var b={init:function(c,a){e.initKeyPair(c,function(d){e.readKeys(c.email,d,a,function(){b.showImportKeys(c,d,a)})},function(a){g("#genKeysForm").submit(function(b){b.preventDefault();b=g("#passphrase").val();e.setPassphrase(b);g("#keygenStatus").html('<div class="progress progress-danger progress-striped active"><div class="bar" style="width: 100%;"></div></div>');a()});g("#disclaimerModal").modal("show")},function(){e.exportKeys(function(a){g("#keygenStatus").html('<h2 class="alert alert-success">Completed! '+
('<a style="float:right" class="btn btn-large btn-danger" download="safewithme.keys.txt" href="'+a+'">Export Keys</a>')+"</h2>")})})},showImportKeys:function(b,a,d){g("#importKeysModal").modal("show");g("#importBtn").click(function(){var h=g("#passphraseImport").val();e.setPassphrase(h);e.fetchKeys(b.email,a,function(){e.readKeys(b.email,a,function(){f.alert("Key import from server successful!");g("#importKeysModal").modal("hide");d()},function(){f.alert("Key import failed... please check your passphrase!")})})})}};
return b}(window,$,CRYPTO);"use strict";
var FS=function(f,g,e){var b={},c=[];b.BucketFS=function(a,d,b){this.version="1.0";this.id=a;this.name=d;this.ownerEmail=b;this.created=(new Date).toISOString();this.root=[]};b.Directory=function(a){this.type="dir";this.name=a;this.created=(new Date).toISOString();this.children=[]};b.File=function(a,d,b,c,e){this.type="file";this.name=a;this.size=d;this.uploaded=(new Date).toISOString();this.mimeType=b;this.blobKey=c;this.cryptoKey=e};b.cacheBucket=function(a,d){c.push({bucket:a,bucketFS:d})};b.currentBucket=
function(){return c[0].bucket};b.currentBucketFS=function(){return c[0].bucketFS};b.readFile=function(a,d){e.blob2BinStr(a,function(a){var b=f.symmetricEncrypt(a),a=e.binStr2ArrBuf(b.ct),a=e.arrBuf2Blob(a,"application/octet-stream"),c=md5(b.ct);g.uploadBlob(a,c,function(a){d(a,b.key)})})};b.getFile=function(a,b){g.downloadBlob(a.blobKey,function(c){e.blob2BinStr(c,function(c){c=f.symmetricDecrypt(a.cryptoKey,c);c=e.binStr2ArrBuf(c);c=e.arrBuf2Blob(c,a.mimeType);e.createUrl(a.name,c,function(a){b(a)})})})};
b.deleteFile=function(a,b){g.deleteBlob(a,function(){b()})};b.getBuckets=function(a){g.call("GET","/app/buckets",function(b){a(b)})};b.getBucketFS=function(a){a=f.asymmetricDecrypt(a);return JSON.parse(a)};b.addFileToBucketFS=function(a,d,c,e){d.root.push(a);b.persistBucketFS(d,c,function(a){e(a)})};b.deleteFileFromBucketFS=function(a,d,c,e){for(var f=0;f<d.root.length;f++){var g=d.root[f];if("file"===g.type&&g.blobKey===a){d.root.splice(f,1);break}}b.persistBucketFS(d,c,function(a){e(a)})};b.persistBucketFS=
function(a,b,c,e){var a=JSON.stringify(a),k=null,k=e?f.asymmetricEncrypt(a,e):f.asymmetricEncrypt(a);b.encryptedFS=k;b.publicKeyId=f.getPublicKeyIdBase64();b=JSON.stringify(b);g.upload("PUT","/app/buckets","application/json",b,function(a){c(a)})};b.createBucket=function(a,d){g.call("POST","/app/buckets",function(c){var e=new b.BucketFS(c.id,a,c.ownerEmail);b.persistBucketFS(e,c,function(a){d(a)})})};b.removeBucket=function(a,b){g.call("DELETE","/app/buckets?bucketId="+a.id,function(a){b(a)})};b.shareFile=
function(a,d,c,e,f){g.call("GET","/app/publicKeys?email="+c,function(n){n&&f&&f();g.call("POST","/app/buckets",function(f){var g=new b.BucketFS(f.id,d,c);g.root.push(a);f.ownerEmail=c;b.persistBucketFS(g,f,function(a){e(a)},n.asciiArmored)})})};return b}(CRYPTO,SERVER,UTIL);"use strict";
var FSVIEW=function(f,g,e,b){var c={init:function(){var a=g.getElementById("holder");a.ondragover=function(){return!1};a.ondragend=function(){return!1};a.ondrop=function(a){a.preventDefault();c.handleFileDrop(a.dataTransfer.files[0])};g.getElementById("files").addEventListener("change",function(a){c.handleFileDrop(a.target.files[0])},!1);b.getBuckets(function(a){if(0===a.length)b.createBucket("Personal Documents",function(a){c.displayBucket(a,0,1)});else for(var e=0;e<a.length;e++)c.displayBucket(a[e],
e,a.length)})},handleFileDrop:function(a){e("#encryptModal").on("shown",function(){b.readFile(a,function(d,f){var g=new b.File(a.name,a.size,a.type,d,f),k=b.currentBucket(),n=b.currentBucketFS();b.addFileToBucketFS(g,n,k,function(){e("#encryptModal").modal("hide");c.addLinkToList(g)})})});e("#encryptModal").modal("show")},displayBucket:function(a){var d=b.getBucketFS(a.encryptedFS);b.cacheBucket(a,d);a='<li class="nav-header">'+d.name+"</li>";e("#buckets").append(a);for(a=0;a<d.root.length;a++)c.addLinkToList(d.root[a])},
addLinkToList:function(a){var d=a.blobKey,f='<li><div><a id="deleteItem" href="'+d+'"><i class="icon-remove icon-black"></i></a><a id="showItem" href="'+d+'">'+a.name+'</a><a id="shareItem" href="'+d+'"><i class="icon-share-alt icon-black"></i></a></div></li>';e("#buckets").append(f);e('#showItem[href="'+d+'"]').click(function(b){b.preventDefault();c.showDocItem(a)});e('#deleteItem[href="'+d+'"]').click(function(a){a.preventDefault();c.deleteDocItem(d)});e('#shareItem[href="'+d+'"]').click(function(a){a.preventDefault();
e("#shareModal").modal("show")});e("#shareForm").submit(function(c){c.preventDefault();var c=e("#login a").html(),d=e("#shareEmail").val();if(!d||""===d)return alert("You must specify the recipient's email!"),!1;b.shareFile(a,"shared by "+c,d,function(){e("#encryptModal").modal("hide")},function(){e("#shareModal").modal("hide");e("#encryptModal").modal("show")});return!1})},showDocItem:function(a){e("#decryptModal").on("shown",function(){b.getFile(a,function(a){e("#decryptModal").modal("hide");c.displayDoc(a)})});
e("#decryptModal").modal("show");return!1},deleteDocItem:function(a){b.deleteFile(a,function(){var c=b.currentBucket(),f=b.currentBucketFS();b.deleteFileFromBucketFS(a,f,c,function(){e('[href="'+a+'"]').remove()})})},displayDoc:function(a){f.location.href=a}};return c}(window,document,$,FS);"use strict";var SAFEWITHME=function(f,g,e,b,c){return{init:function(){e.init("http://safewith.me",function(a){a.loggedIn&&a.email&&b.init(a,function(){c.init()})})}}}(window,navigator,MENUVIEW,CRYPTOVIEW,FSVIEW);
$(function(){SAFEWITHME.init()});
